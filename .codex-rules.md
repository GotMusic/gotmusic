# CODEX Rules & Prompt for GotMusic

> **Purpose:** Guide CODEX AI analysis and suggestions for the GotMusic ETHOnline 2025 project
> **Project:** GotMusic — Music NFT Platform with Web3 Integration
> **Context:** Monorepo with Next.js (web), Expo (mobile), shared packages, and comprehensive CI/CD

---

## 🎯 **CODEX Analysis Focus Areas**

### **🔴 CRITICAL Issues to Detect:**
1. **Module Resolution Errors** - Missing workspace dependencies, import failures
2. **SSR Compatibility Issues** - Server-side rendering problems, browser API usage in server components
3. **Token Build Dependencies** - Missing `@gotmusic/tokens` builds before server start
4. **CI/CD Pipeline Failures** - Build, test, or deployment issues
5. **Authentication Security** - Session handling, HMAC signing, cookie security
6. **TypeScript Errors** - Type mismatches, missing imports, strict mode violations

### **🟠 HIGH Priority Issues:**
1. **Design System Violations** - Hard-coded colors/spacing instead of tokens
2. **Performance Issues** - Bundle size, rendering performance, memory leaks
3. **Accessibility Problems** - ARIA labels, keyboard navigation, screen reader support
4. **Mobile Compatibility** - React Native specific issues, Expo compatibility
5. **API Integration** - Fetch errors, response handling, error boundaries

### **🟡 MEDIUM Priority Issues:**
1. **Code Quality** - Unused imports, console statements, code duplication
2. **Documentation** - Missing JSDoc, outdated comments, README updates
3. **Testing Coverage** - Missing test cases, flaky tests, test organization
4. **Security** - Environment variable exposure, sensitive data handling

---

## 📋 **CODEX Analysis Rules**

### **1. Repository Structure Understanding**
```
GotMusic/
├── apps/
│   ├── web/          # Next.js 15.5.4 (App Router)
│   ├── mobile/       # Expo with NativeWind
│   └── worker/       # Background processing
├── packages/
│   ├── api/          # Shared API client
│   ├── ui/           # Shared UI components
│   ├── tokens/       # Design tokens (Style Dictionary)
│   ├── icons/        # Icon components
│   └── fixtures/     # Test data
├── docs.d/           # Documentation
└── scripts/          # Automation scripts
```

### **2. Technology Stack Awareness**
- **Web:** Next.js 15.5.4, React 19, Tailwind CSS, TypeScript strict mode
- **Mobile:** Expo, React Native, NativeWind, TypeScript
- **Monorepo:** Yarn workspaces, Turbo, shared packages
- **CI/CD:** GitHub Actions, Playwright E2E, comprehensive testing
- **Design System:** Style Dictionary tokens, shared UI components

### **3. Critical Dependencies & Build Order**
```bash
# REQUIRED build order for CI/CD success:
1. yarn tokens:build          # Design tokens first
2. yarn workspace @gotmusic/ui build  # UI package second  
3. yarn workspace @gotmusic/web build # Web app last
```

### **4. Common Issue Patterns to Detect**

#### **Module Resolution Issues:**
```typescript
// ❌ BAD - Will cause "Module not found" errors
import { Component } from "@gotmusic/ui";  // If UI package not built

// ✅ GOOD - After proper build order
import { Component } from "@gotmusic/ui";  // Works after build
```

#### **SSR Issues:**
```typescript
// ❌ BAD - Browser APIs in server components
export default function ServerComponent() {
  const [state, setState] = useState();  // Client-side only
  return <div>{window.location.href}</div>;  // Browser API
}

// ✅ GOOD - Proper SSR patterns
"use client";
export default function ClientComponent() {
  const [state, setState] = useState();
  return <div>{window.location.href}</div>;
}
```

#### **Design System Violations:**
```typescript
// ❌ BAD - Hard-coded values
<div className="bg-[#0B0D12] text-[#E6EAF2] p-[16px]">

// ✅ GOOD - Token-based classes
<div className="bg-bg text-fg p-4">
```

### **5. CI/CD Pipeline Requirements**
- **Build artifacts must exist** before server start
- **Environment variables** properly configured
- **Database migrations** completed before tests
- **Token packages built** before web server
- **No console.log statements** in production builds

---

## 🔧 **CODEX Fix Generation Rules**

### **1. Fix Priority Order:**
1. **Build/Module Issues** - Fix first (blocks everything)
2. **SSR/Client Issues** - Fix second (affects rendering)
3. **TypeScript Errors** - Fix third (affects development)
4. **Code Quality** - Fix last (improvements)

### **2. Fix Generation Patterns:**

#### **For Module Resolution:**
```typescript
// Add to package.json scripts:
"predev": "yarn workspaces foreach -p -A --include @gotmusic/tokens --include @gotmusic/ui run build"
"prestart": "yarn workspaces foreach -p -A --include @gotmusic/tokens --include @gotmusic/ui run build"
```

#### **For SSR Issues:**
```typescript
// Add "use client" directive
"use client";
export default function ClientComponent() {
  // Client-side code here
}
```

#### **For Design System:**
```typescript
// Replace hard-coded values with tokens
// OLD: className="bg-[#0B0D12]"
// NEW: className="bg-bg"
```

### **3. PR Creation Guidelines:**
- **Title:** Clear, descriptive, follows conventional commits
- **Body:** Explains the issue, solution, and testing
- **Files:** Only touch necessary files, avoid wide changes
- **Testing:** Include verification steps

---

## 📚 **Documentation References**

### **Critical Files to Reference:**
- **`.cursorrules`** - Project conventions and guardrails
- **`docs.d/INDEX.md`** - Complete documentation index
- **`docs.d/AUTH-MASTER.md`** - Authentication system requirements
- **`docs.d/design-system/README.md`** - Design system guidelines
- **`docs.d/ci-cd/CI-CD-GUIDE.md`** - CI/CD pipeline documentation

### **Key Documentation Sections:**
1. **Code Style** - TypeScript strict, React patterns, naming conventions
2. **Security** - Session handling, environment variables, authentication
3. **Performance** - Bundle optimization, rendering patterns, caching
4. **Testing** - E2E requirements, unit test patterns, CI integration
5. **Design System** - Token usage, component patterns, accessibility

---

## 🚨 **Error Detection Patterns**

### **Build Failures:**
```bash
# Look for these error patterns:
- "Module not found: Can't resolve"
- "BUILD_ID missing"
- "Could not find a production build"
- "ReferenceError: require is not defined"
```

### **Runtime Errors:**
```bash
# Look for these error patterns:
- "ERR_TOO_MANY_REDIRECTS"
- "500 Internal Server Error"
- "Module not found" in browser console
- "Cannot read property of undefined"
```

### **CI/CD Failures:**
```bash
# Look for these error patterns:
- "Process completed with exit code 1"
- "Server process died immediately"
- "Missing BUILD_ID in .next"
- "Homepage code: 500"
```

---

## 🎯 **CODEX Action Items**

### **When Creating PRs:**
1. **Analyze the specific issue** using the patterns above
2. **Generate minimal, targeted fixes** that address root causes
3. **Include proper testing instructions** in PR description
4. **Reference relevant documentation** from docs.d/
5. **Follow conventional commit format** for titles
6. **Avoid mentioning AI models** in PR descriptions

### **When Detecting Issues:**
1. **Prioritize build-blocking issues** first
2. **Check for related issues** in the same file/area
3. **Verify fix doesn't break existing functionality**
4. **Consider monorepo dependencies** and build order
5. **Ensure CI/CD compatibility** with proposed changes

---

## 🔍 **Analysis Checklist**

Before generating fixes, CODEX should verify:
- [ ] **Build order** is correct (tokens → ui → web)
- [ ] **Module dependencies** are properly declared
- [ ] **SSR compatibility** is maintained
- [ ] **Design system tokens** are used correctly
- [ ] **TypeScript strict mode** compliance
- [ ] **CI/CD pipeline** compatibility
- [ ] **Security best practices** are followed
- [ ] **Documentation** is updated if needed

---

**Last Updated:** 2025-10-24  
**Maintainer:** GotMusic Development Team  
**Context:** ETHOnline 2025 Hackathon Project
